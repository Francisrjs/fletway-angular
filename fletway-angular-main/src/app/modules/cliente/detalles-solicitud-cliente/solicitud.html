<div class="bg-fletway-beige min-h-screen flex flex-col">
  <div
    class="flex flex-col w-full h-full bg-white shadow-lg rounded-none overflow-hidden"
  >
    @if (!newSolicitud) {
    <header
      class="w-full bg-fletway-orange p-4 flex items-center justify-between shadow-fletway"
    >
      <div class="flex items-center">
        <button
          (click)="cancel()"
          class="text-fletway-white text-2xl mr-4 focus:outline-none hover:opacity-80"
          title="Volver atrás"
        >
          <i class="fas fa-arrow-left"></i>
        </button>
        <h1 class="text-fletway-white text-xl font-semibold">
          Solicitar Flete
        </h1>
      </div>
      <button
        class="text-fletway-white text-2xl focus:outline-none hover:opacity-80"
        title="Perfil de usuario"
      >
        <i class="fas fa-user-circle"></i>
      </button>
    </header>
    }
    <main class="flex-grow flex flex-col p-6 w-full overflow-y-auto">
      @if (!newSolicitud) {
      <h2 class="text-fletway-blue-gray text-2xl font-bold mb-6 text-center">
        Detalles del pedido
      </h2>
      }

      @if (message.type) {
      <div
        [class]="
            'p-4 mb-4 rounded-lg text-sm font-medium ' +
            (message.type === 'success'
              ? 'bg-green-100 text-green-800'
              : 'bg-red-100 text-red-800')
          "
        role="alert"
      >
        {{ message.text }}
      </div>
      }

      <form
        [formGroup]="solicitudForm"
        (ngSubmit)="onSubmit()"
        class="space-y-6"
      >
        <div class="relative">
          <label
            class="block mb-2 text-sm font-medium text-gray-dark"
          >
            Localidad origen *
          </label>

          <input
            type="text"
            [value]="textoLocalidadOrigen"
            (input)="filtrarLocalidadesOrigen($event)"
            (focus)="mostrarDropdownOrigen = true"
            (blur)="onBlurOrigen()"
            placeholder="Escriba para buscar localidad..."
            autocomplete="off"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          />

          @if (mostrarDropdownOrigen && localidadesOrigenFiltradas.length > 0) {
            <ul class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto mt-1">
              @for (loc of localidadesOrigenFiltradas; track loc.localidad_id) {
                <li
                  (click)="seleccionarLocalidadOrigen(loc)"
                  class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700 border-b last:border-0 flex justify-between items-center"
                >
                  <span><span class="font-semibold">{{ loc.nombre }}</span>, {{ loc.provincia }}</span>
                </li>
              }
            </ul>
          }

          @if (mostrarDropdownOrigen && localidadesOrigenFiltradas.length === 0 && textoLocalidadOrigen.length > 0) {
            <div class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-3 mt-1 text-sm text-gray-500">
              No se encontraron localidades.
            </div>
          }

          @if (
            solicitudForm.get("localidad_origen_id")?.invalid &&
            solicitudForm.get("localidad_origen_id")?.touched
          ) {
            <p class="text-red-600 text-sm mt-1">
              <i class="fas fa-exclamation-circle mr-1"></i>
              Debe seleccionar una localidad de la lista
            </p>
          }
        </div>

        <div>
          <label
            for="origin"
            class="block text-fletway-blue-gray text-sm font-medium mb-1"
          >
            Origen (Dirección exacta o Mapa)
          </label>
          <input
            type="text"
            id="origin"
            name="origin"
            formControlName="origen"
            placeholder="Ej: Calle Falsa 123"
            class="w-full p-3 border rounded-lg focus:ring-2 focus:border-fletway-orange text-fletway-blue-gray placeholder-gray-400"
            [class.border-red-500]="origen?.invalid && origen?.touched"
            [class.border-green-500]="
              origen?.valid && origen?.touched && origen?.value
            "
            [class.border-gray-300]="!origen?.touched"
            [class.focus:ring-red-500]="origen?.invalid && origen?.touched"
            [class.focus:ring-green-500]="origen?.valid && origen?.touched"
          />
          @if (origen?.errors && origen?.touched) {
          <p class="text-red-600 text-sm mt-1">
            <i class="fas fa-exclamation-circle mr-1"></i>
            Por favor ingrese una dirección de origen válida
          </p>
          }
          @if (validandoDireccionOrigen) {
          <p class="text-blue-500 text-xs mt-1">
            <i class="fas fa-spinner fa-spin mr-1"></i>
            Validando dirección...
          </p>
          } @else if (origen?.value && origen?.value.length > 5) { @if
          (direccionOrigenValida) {
          <p class="text-green-600 text-xs mt-1">
            <i class="fas fa-check-circle mr-1"></i>
            Dirección válida - coordenadas encontradas
          </p>
          } @else {
          <p class="text-amber-600 text-xs mt-1">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            No se encontraron coordenadas para esta dirección
          </p>
          } }
        </div>

        <div class="relative">
          <label
            class="block mb-2 text-sm font-medium text-gray-dark"
          >
            Localidad del Destino *
          </label>

          <input
            type="text"
            [value]="textoLocalidadDestino"
            (input)="filtrarLocalidadesDestino($event)"
            (focus)="mostrarDropdownDestino = true"
            (blur)="onBlurDestino()"
            placeholder="Escriba para buscar localidad..."
            autocomplete="off"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          />

          @if (mostrarDropdownDestino && localidadesDestinoFiltradas.length > 0) {
            <ul class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto mt-1">
              @for (loc of localidadesDestinoFiltradas; track loc.localidad_id) {
                <li
                  (click)="seleccionarLocalidadDestino(loc)"
                  class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700 border-b last:border-0"
                >
                  <span class="font-semibold">{{ loc.nombre }}</span>, {{ loc.provincia }}
                </li>
              }
            </ul>
          }

          @if (mostrarDropdownDestino && localidadesDestinoFiltradas.length === 0 && textoLocalidadDestino.length > 0) {
            <div class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg p-3 mt-1 text-sm text-gray-500">
              No se encontraron localidades.
            </div>
          }

          @if (
            solicitudForm.get("localidad_destino_id")?.invalid &&
            solicitudForm.get("localidad_destino_id")?.touched
          ) {
            <p class="text-red-600 text-sm mt-1">
              <i class="fas fa-exclamation-circle mr-1"></i>
              Debe seleccionar una localidad de destino
            </p>
          }
        </div>

        <div>
          <label
            for="destination"
            class="block text-blue-gray-dark text-sm font-medium mb-1"
          >
            Destino (Dirección exacta o Mapa)
          </label>
          <input
            type="text"
            id="destination"
            name="destination"
            formControlName="destino"
            placeholder="Ej: Av. Siempre Viva 742"
            class="w-full p-3 border rounded-lg focus:ring-2 focus:border-secondary-orange text-blue-gray-dark placeholder-gray-400 dark:placeholder-gray-400"
            [class.border-red-500]="destino?.invalid && destino?.touched"
            [class.border-green-500]="
              destino?.valid && destino?.touched && destino?.value
            "
            [class.border-gray-300]="!destino?.touched"
            [class.focus:ring-red-500]="destino?.invalid && destino?.touched"
            [class.focus:ring-green-500]="destino?.valid && destino?.touched"
          />
          @if (destino?.errors && destino?.touched) {
          <p class="text-red-600 text-sm mt-1">
            <i class="fas fa-exclamation-circle mr-1"></i>
            Por favor ingrese una dirección de destino válida
          </p>
          }
          @if (validandoDireccionDestino) {
          <p class="text-blue-500 text-xs mt-1">
            <i class="fas fa-spinner fa-spin mr-1"></i>
            Validando dirección...
          </p>
          } @else if (destino?.value && destino?.value.length > 5) { @if
          (direccionDestinoValida) {
          <p class="text-green-600 text-xs mt-1">
            <i class="fas fa-check-circle mr-1"></i>
            Dirección válida - coordenadas encontradas
          </p>
          } @else {
          <p class="text-amber-600 text-xs mt-1">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            No se encontraron coordenadas para esta dirección
          </p>
          } }
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label
              for="pickupDate"
              class="block text-blue-gray-dark text-sm font-medium mb-1"
            >
              Fecha de Recogida
            </label>
            <input
              type="date"
              id="pickupDate"
              formControlName="fechaRecogida"
              [min]="fechaMinima"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary-orange focus:border-secondary-orange text-blue-gray-dark"
            />
            <p class="text-blue-600 text-xs mt-1 italic">
              <i class="fas fa-info-circle mr-1"></i>
              Recomendación: Programe su solicitud con 1-2 días de anticipación
              para mejores resultados
            </p>
          </div>
          <div>
            <label
              for="pickupTimeDesde"
              class="block text-blue-gray-dark text-sm font-medium mb-1"
            >
              Hora de Recogida Desde
            </label>
            <input
              type="time"
              id="pickupTimeDesde"
              formControlName="horaRecogidaDesde"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary-orange focus:border-secondary-orange text-blue-gray-dark"
            />
          </div>
          <div>
            <label
              for="pickupTimeHasta"
              class="block text-blue-gray-dark text-sm font-medium mb-1"
            >
              Hora de Recogida Hasta
            </label>
            <input
              type="time"
              id="pickupTimeHasta"
              formControlName="horaRecogidaHasta"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary-orange focus:border-secondary-orange text-blue-gray-dark"
            />
          </div>
          <div>
            <label
              for="tolerancia"
              class="block text-blue-gray-dark text-sm font-medium mb-1"
            >
              Tolerancia (minutos)
            </label>
            <input
              type="number"
              id="tolerancia"
              formControlName="tolerancia_min"
              placeholder="Ej: 15"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary-orange focus:border-secondary-orange text-blue-gray-dark placeholder-gray-400 dark:placeholder-gray-400"
            />
          </div>
        </div>

        <div
          class="bg-white p-4 rounded-xl shadow-md border border-gray-200 mb-6"
        >
          @if (puedeMostrarMapa) {
          <h3 class="text-blue-gray-dark text-xl font-semibold mb-3">
            Mapa de la ruta
          </h3>
          <app-map
            [direccionOrigen]="solicitudForm.value.origen"
            [ciudadOrigen]="
                getLocalidadNombre(solicitudForm.value.localidad_origen_id)
              "
            [localidadOrigen]="
                getLocalidadProvincia(solicitudForm.value.localidad_origen_id)
              "
            [direccionDestino]="solicitudForm.value.destino"
            [ciudadDestino]="
                getLocalidadNombre(solicitudForm.value.localidad_destino_id)
              "
            [localidadDestino]="
                getLocalidadProvincia(solicitudForm.value.localidad_destino_id)
              "
            (direccionOrigenChange)="onMapOrigenChange($event)"
            (direccionDestinoChange)="onMapDestinoChange($event)"
          />
          } @else {
          <p class="text-gray-500 text-sm">
            Completa los campos de origen y destino para ver el mapa.
          </p>
          }
        </div>

        <div>
          <label
            for="detalle_carga"
            class="block text-blue-gray-dark text-sm font-medium mb-2"
          >
            Características de la Carga
          </label>

          <div class="mb-4">
            <label
              for="detalle_carga"
              class="block text-blue-gray-dark text-sm font-medium mb-1"
            >
              Título de la carga *
            </label>
            <input
              type="text"
              id="detalle_carga"
              formControlName="detalle_carga"
              placeholder="Ej: Un par de sillas"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary-orange focus:border-secondary-orange text-blue-gray-dark placeholder-gray-400 dark:placeholder-gray-400"
            />
          </div>

          <div class="mb-4">
            <label
              for="fotosSolicitud"
              class="block text-fletway-blue-gray text-sm font-medium mb-2"
            >
              Fotos de la Carga (Opcional)
            </label>

            <div class="flex flex-col gap-3">
              <div class="relative">
                <input
                  type="file"
                  id="fotosSolicitud"
                  accept="image/png,image/jpeg,image/jpg"
                  multiple
                  (change)="onFileSelect($event)"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fletway-orange text-fletway-blue-gray file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-500 file:text-white hover:file:bg-orange-600 transition-all"
                  [disabled]="
                    subiendoFotos || fotosSeleccionadas.length >= MAX_FOTOS
                  "
                />
              </div>

              <div class="flex items-start gap-2">
                <i class="fas fa-info-circle text-blue-500 text-sm mt-0.5"></i>
                <p class="text-xs text-gray-600">
                  Máximo {{ MAX_FOTOS }} fotos (5MB cada una). Formatos: PNG,
                  JPG. {{ fotosSeleccionadas.length }}/{{ MAX_FOTOS }} fotos
                  agregadas
                </p>
              </div>

              @if (previsualizacionFotos.length > 0) {
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="flex flex-col gap-3">
                  <div
                    class="relative w-full h-64 bg-gray-200 rounded-lg overflow-hidden"
                  >
                    <img
                      [src]="previsualizacionFotos[0]"
                      alt="Foto principal de la carga"
                      class="w-full h-full object-contain cursor-pointer hover:opacity-90 transition-opacity"
                      (click)="abrirPopupFoto(0)"
                    />
                    <button
                      type="button"
                      (click)="onRemoveFoto(0)"
                      class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition-colors"
                      title="Eliminar foto"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                    <div
                      class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs"
                    >
                      1/{{ previsualizacionFotos.length }}
                    </div>
                  </div>

                  @if (previsualizacionFotos.length > 1) {
                  <div class="grid grid-cols-4 gap-2">
                    @for ( foto of previsualizacionFotos.slice(1); track foto;
                    let i = $index ) {
                    <div class="relative group">
                      <img
                        [src]="foto"
                        [alt]="'Foto ' + (i + 2)"
                        [title]="'Ver foto ' + (i + 2)"
                        class="w-full h-20 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-fletway-orange transition-all"
                        (click)="abrirPopupFoto(i + 1)"
                      />
                      <button
                        type="button"
                        (click)="onRemoveFoto(i + 1)"
                        class="absolute -top-1 -right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md opacity-0 group-hover:opacity-100 transition-opacity"
                        title="Eliminar"
                      >
                        <i class="fas fa-times text-xs"></i>
                      </button>
                    </div>
                    }
                  </div>
                  }
                </div>

                @if (subiendoFotos) {
                <div class="mt-3 flex items-center gap-2 text-sm text-blue-600">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>Subiendo foto...</span>
                </div>
                }
              </div>
              }
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label
                for="dimensions"
                class="block text-blue-gray-dark text-sm font-medium mb-1"
              >
                Dimensiones (cm) *
              </label>
              <input
                type="text"
                id="dimensions"
                formControlName="detalle"
                placeholder="Ej: ALTO X ANCHO X PROFUNDIDAD, 150x130x3"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary-orange focus:border-secondary-orange text-blue-gray-dark placeholder-gray-400 dark:placeholder-gray-400"
              />
            </div>
            <div>
              <label
                for="weight"
                class="block text-blue-gray-dark text-sm font-medium mb-1"
              >
                Peso (kg) *
              </label>
              <input
                type="number"
                id="weight"
                formControlName="peso"
                placeholder="Ej: 200"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary-orange focus:border-secondary-orange text-blue-gray-dark placeholder-gray-400 dark:placeholder-gray-400"
              />
            </div>
          </div>
        </div>

        <div class="flex justify-around mt-8 space-x-4">
          <button
            type="button"
            (click)="cancel()"
            class="w-1/2 py-3 px-6 bg-white text-blue-gray-dark border border-blue-gray-dark rounded-xl shadow-md text-lg font-bold transform transition duration-300 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Cancelar
          </button>
          <button
            type="submit"
            [disabled]="submitting"
            class="w-1/2 py-3 px-6 bg-orange-500 text-white rounded-xl shadow-fletway text-lg font-bold transform transition duration-300 hover:scale-105 hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {{ submitting ? "Enviando..." : "Confirmar pedido" }}
          </button>
        </div>
      </form>
    </main>

    <footer class="w-full bg-blue-gray-dark p-3 text-center text-white text-sm">
      &copy; 2025 Fletway. Todos los derechos reservados.
    </footer>
  </div>
</div>

@if (mostrarPopupFoto && fotoSeleccionadaIndex !== null) {
<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4"
  (click)="cerrarPopupFoto()"
>
  <div
    class="relative max-w-4xl max-h-[90vh] bg-white rounded-lg overflow-hidden shadow-2xl"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between p-4 bg-fletway-beige border-b">
      <h3 class="text-lg font-semibold text-fletway-blue-gray">
        Foto {{ fotoSeleccionadaIndex + 1 }} de {{ previsualizacionFotos.length }}
      </h3>
      <button
        type="button"
        (click)="cerrarPopupFoto()"
        class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
        title="Cerrar"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>

    <div class="flex items-center justify-center bg-gray-100 p-6">
      <img
        [src]="previsualizacionFotos[fotoSeleccionadaIndex]"
        [alt]="'Foto ' + (fotoSeleccionadaIndex + 1)"
        [title]="
            'Foto ' +
            (fotoSeleccionadaIndex + 1) +
            ' de ' +
            previsualizacionFotos.length
          "
        class="max-w-full max-h-[70vh] object-contain rounded-lg shadow-lg"
      />
    </div>

    <div class="p-4 bg-gray-50 border-t">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-600">
          <p class="font-medium">
            {{ fotosSeleccionadas[fotoSeleccionadaIndex]?.name }}
          </p>
          <p class="text-xs text-gray-500">
            {{ (fotosSeleccionadas[fotoSeleccionadaIndex]?.size || 0) / 1024 /
            1024 | number: "1.2-2" }} MB
          </p>
        </div>
        <button
          type="button"
          (click)="onRemoveFoto(fotoSeleccionadaIndex); cerrarPopupFoto()"
          class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors text-sm font-medium"
        >
          <i class="fas fa-trash mr-2"></i>
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
}