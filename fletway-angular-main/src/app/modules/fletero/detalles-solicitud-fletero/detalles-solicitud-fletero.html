<div
  class="flex flex-col flex-grow items-center justify-start w-full max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden"
>
  <!-- Top bar -->
  <header
    class="w-full bg-primary-orange p-4 flex items-center justify-between rounded-t-lg shadow-md"
  >
    <div class="flex items-center">
      <button
        id="backButton"
        class="text-white text-2xl mr-4 focus:outline-none"
      >
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-white text-xl font-semibold">Realizar cotización</h1>
    </div>
    <button class="text-white text-2xl focus:outline-none">
      <i class="fas fa-user-circle"></i>
    </button>
  </header>

  <!-- Main content -->
  <main class="flex-grow flex flex-col p-6 w-full overflow-y-auto">
    <h2 class="text-blue-gray-dark text-2xl font-bold mb-6 text-center">
      Detalles del pedido
    </h2>

    <!-- Loading / Error -->
    <div *ngIf="loading" class="text-center py-6">Cargando solicitud...</div>
    <div *ngIf="error && !loading" class="text-center text-red-600 py-6">
      No se pudo cargar la solicitud.
    </div>

    <ng-container *ngIf="pedido && !loading">
      <!-- Request Details Section -->
      <div
        class="bg-white p-4 rounded-xl shadow-md border border-gray-200 mb-6"
      >
        <h3 class="text-blue-gray-dark text-xl font-semibold mb-3">
          Información del pedido
        </h3>
        <p class="text-gray-700 mb-1">
          <span class="font-medium">Titulo:</span>
          {{ pedido.detalles_carga }}
        </p>
        <p class="text-gray-700 mb-1">
          <span class="font-medium">Origen:</span>
          {{ pedido.direccion_origen }}
          <span *ngIf="pedido.localidad_origen"
            >, {{ pedido.localidad_origen.nombre }}</span
          >
        </p>
        <p class="text-gray-700 mb-1">
          <span class="font-medium">Destino:</span>
          {{ pedido.direccion_destino }}, {{ pedido.localidad_destino?.nombre }}
        </p>
        <!-- Si tenés dimensiones/peso en 'detalles_carga' podés parsearlo; dejo placeholders cuando no existe -->
        <p class="text-gray-700 mb-1">
          <span class="font-medium">Dimensiones:</span>
          {{ pedido.medidas ? (pedido.medidas | slice: 0 : 40) : "---" }}
        </p>
        <p class="text-gray-700 mb-1" *ngIf="pedido.peso">
          <span class="font-medium">Peso:</span>
          {{ pedido.peso ? "ver detalles" : "---" }}
        </p>
        <p class="text-gray-700 mb-1">
          <span class="font-medium">Medidas:</span>
          {{ pedido.medidas ? "ver detalles" : "---" }}
        </p>
        <p class="text-gray-700 mb-3">
          <span class="font-medium">Fecha/Hora Recogida:</span>
          {{ pedido.hora_recogida | date: "dd/MM/yyyy HH:mm" }}
        </p>

        <h4 class="text-blue-gray-dark text-lg font-semibold mb-2">
          Fotos de la Carga:
        </h4>

        @if (tieneFoto(pedido)) {
          <!-- Mostrar foto si existe -->
          <div class="relative group">
            <button
              type="button"
              [attr.aria-label]="'Ver foto de ' + pedido.detalles_carga"
              (click)="abrirFotoModal(pedido)"
              (keydown.enter)="abrirFotoModal(pedido)"
              (keydown.space)="abrirFotoModal(pedido)"
              class="w-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 rounded-lg"
            >
              <img
                [src]="obtenerUrlFoto(pedido)"
                [alt]="'Foto de ' + pedido.detalles_carga"
                class="h-64 w-full rounded-lg object-contain bg-gray-100 shadow-md cursor-pointer transition-transform hover:scale-105 border border-gray-200"
                (error)="handleImageError($event)"
              />
            </button>
            <div
              class="absolute top-2 right-2 bg-white rounded-full p-2 shadow-md opacity-0 group-hover:opacity-100 transition-opacity"
            >
              <svg
                class="w-5 h-5 text-gray-700"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
            </div>
          </div>
        } @else {
          <!-- Placeholder si no hay foto -->
          <div
            class="flex items-center justify-center h-64 w-full rounded-lg border-2 border-dashed border-gray-300 bg-gray-50"
          >
            <div class="text-center">
              <svg
                class="mx-auto h-12 w-12 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                />
              </svg>
              <p class="mt-2 text-sm text-gray-500">Sin foto disponible</p>
            </div>
          </div>
        }
      </div>
      <div
        class="bg-white p-4 rounded-xl shadow-md border border-gray-200 mb-6"
      >
        <h3 class="text-blue-gray-dark text-xl font-semibold mb-3">Mapa</h3>
        @if (
          pedido.direccion_origen &&
          pedido.localidad_origen?.nombre &&
          pedido.localidad_origen
        ) {
          <app-map
            [direccionOrigen]="pedido.direccion_origen"
            [ciudadOrigen]="pedido.localidad_origen.nombre ?? undefined"
            [localidadOrigen]="pedido.localidad_origen.provincia ?? undefined"
            [direccionDestino]="pedido.direccion_destino ?? undefined"
            [ciudadDestino]="pedido.localidad_destino?.nombre ?? undefined"
            [localidadDestino]="pedido.localidad_origen.provincia ?? undefined"
          />
        }
      </div>
      <div
        class="bg-white p-4 rounded-xl shadow-md border border-gray-200 mb-6"
      >
        <h3 class="text-blue-gray-dark text-xl font-semibold mb-3">
          Información del Cliente
        </h3>
        <div class="flex items-center">
          <img
            src="boy.png"
            alt="Perfil Cliente"
            class="w-16 h-16 rounded-full object-cover mr-4 border border-gray-300"
          />
          <div>
            <p class="text-blue-gray-dark text-lg font-medium">
              {{ pedido.cliente?.nombre || "Nombre del Cliente" }}
              {{ pedido.cliente?.apellido || "" }}
            </p>
            <p class="text-gray-600 text-sm">{{ pedido.cliente?.email }}</p>
            <p class="text-gray-600 text-sm">{{ pedido.cliente?.telefono }}</p>
          </div>
        </div>
      </div>

      <!-- Quote Form Section -->
      <div
        class="bg-white p-4 rounded-xl shadow-md border border-gray-200 mb-6"
      >
        <h3 class="text-blue-gray-dark text-xl font-semibold mb-3">
          Realizar Cotización
        </h3>
        <form
          [formGroup]="presupuestoForm"
          (ngSubmit)="submitQuote()"
          class="space-y-4"
          novalidate
        >
          <div>
            <label
              for="price"
              class="block text-blue-gray-dark text-sm font-medium mb-1"
              >Precio de la Cotización (ARS)</label
            >
            <input
              type="number"
              id="price"
              placeholder="Ej: 5000"
              class="w-full p-3 border border-gray-300 rounded-lg focus-ring-primary-orange text-blue-gray-dark"
              formControlName="precio"
            />
          </div>
          <div>
            <label
              for="notes"
              class="block text-blue-gray-dark text-sm font-medium mb-1"
              >Notas breves (opcional)</label
            >
            <textarea
              id="notes"
              rows="3"
              placeholder="Ej: El precio incluye peajes."
              formControlName="comentario"
              class="w-full p-3 border border-gray-300 rounded-lg focus-ring-primary-orange text-blue-gray-dark"
            ></textarea>
          </div>
          <div class="flex justify-around mt-6 space-x-4">
            <button
              type="button"
              (click)="cancelQuote()"
              class="w-1/2 py-3 px-6 bg-white text-blue-gray-dark border border-blue-gray-dark rounded-xl shadow-md text-lg font-bold transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-gray-dark focus:ring-opacity-75"
            >
              Cancelar
            </button>
            <button
              type="submit"
              [disabled]="presupuestoForm.invalid"
              class="w-1/2 py-3 px-6 bg-orange-400 text-white rounded-xl shadow-md text-lg font-bold transform transition duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary-orange focus:ring-opacity-75"
            >
              Enviar Cotización
            </button>
          </div>
        </form>
      </div>
    </ng-container>
  </main>

  <!-- Footer -->
  <footer
    class="w-full bg-blue-gray-dark p-3 text-center text-white text-sm rounded-b-lg"
  >
    &copy; 2025 Fletway. Todos los derechos reservados.
  </footer>
</div>

<!-- Modal de visualización de foto en pantalla completa -->
@if (fotoModalAbierta && fotoModalUrl) {
  <div
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 p-4"
    (click)="cerrarFotoModal()"
    (keydown.escape)="cerrarFotoModal()"
    role="dialog"
    aria-modal="true"
    [attr.aria-label]="'Modal de visualización: ' + fotoModalTitulo"
  >
    <div
      class="relative bg-white rounded-lg shadow-2xl max-w-4xl max-h-[90vh] flex flex-col"
      role="presentation"
      (click)="$event.stopPropagation()"
    >
      <!-- Header del modal -->
      <div class="flex items-center justify-between p-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900">
          {{ fotoModalTitulo }}
        </h2>
        <button
          type="button"
          (click)="cerrarFotoModal()"
          (keydown.enter)="cerrarFotoModal()"
          (keydown.space)="cerrarFotoModal()"
          class="inline-flex items-center justify-center rounded-md text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-500"
          [attr.aria-label]="'Cerrar modal'"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>

      <!-- Contenedor de imagen -->
      <div class="flex items-center justify-center flex-1 overflow-auto p-4 bg-gray-50">
        <img
          [src]="fotoModalUrl"
          [alt]="fotoModalTitulo"
          class="max-w-full max-h-full object-contain rounded-lg"
        />
      </div>

      <!-- Footer del modal -->
      <div class="flex justify-end gap-2 p-4 border-t border-gray-200">
        <button
          type="button"
          (click)="cerrarFotoModal()"
          class="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-gray-200"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
}
