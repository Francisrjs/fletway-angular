<!-- Chat Container -->
<div class="flex flex-col h-full bg-white rounded-lg shadow-lg overflow-hidden">
  <!-- Header -->
  <div class="bg-fletway-orange p-4 flex items-center justify-between">
    <h3 class="text text-lg font-semibold flex items-center gap-2">
      <i class="fas fa-comments"></i>
      Chat de Negociación
    </h3>
    <span class="text-orange-500 text-sm"> Solicitud #{{ solicitudId }} </span>
  </div>

  <!-- Messages Area -->
  <div
    id="chat-messages"
    class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50"
  >
    <!-- Skeleton Loader -->
    @if (mostrarSkeletons() && loading()) {
      @for (skeleton of [1, 2, 3]; track skeleton) {
        <div class="flex gap-2.5 animate-pulse">
          <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
          <div class="flex flex-col space-y-2 flex-1 max-w-xs">
            <div class="h-4 bg-gray-300 rounded w-24"></div>
            <div class="h-16 bg-gray-300 rounded"></div>
          </div>
        </div>
      }
    }

    <!-- Mensaje vacío inicial -->
    @if (!loading() && !hayMensajes()) {
      <div
        class="flex flex-col items-center justify-center h-full text-center py-12"
      >
        <i class="fas fa-comment-dots text-6xl text-gray-300 mb-4"></i>
        <p class="text-gray-500 text-lg font-medium mb-2">
          No hay mensajes aún
        </p>
        <p class="text-gray-400 text-sm max-w-md">
          "Quiero negociar el precio con el fletero"
        </p>
        <p class="text-gray-400 text-xs mt-4">
          Inicia la conversación enviando un mensaje
        </p>
      </div>
    }

    <!-- Lista de Mensajes -->
    @for (mensaje of mensajes().mensajes; track mensaje.id) {
      <!-- Mensaje del otro usuario (izquierda) -->
      @if (!mensaje.esMio) {
        <div class="flex items-start gap-2.5">
          <div
            class="w-8 h-8 rounded-full bg-fletway-orange flex items-center justify-center text font-bold"
          >
            <i class="fas fa-user text-sm"></i>
          </div>
          <div
            class="flex flex-col w-full max-w-[320px] leading-1.5 p-3 bg-white border border-gray-200 rounded-e-lg rounded-es-lg shadow-sm"
          >
            <div class="flex items-center space-x-2 mb-1">
              <span class="text-xs text-gray-300">
                {{ formatearFecha(mensaje.created_at) }}
              </span>
            </div>
            <p class="text-sm text-gray-900 whitespace-pre-wrap">
              {{ mensaje.mensaje }}
            </p>
            @if (mensaje.edited_at) {
              <span class="text-xs text-gray-400 italic mt-1">Editado</span>
            }
          </div>
        </div>
      }

      <!-- Mensaje propio (derecha) -->
      @if (mensaje.esMio) {
        <div class="flex items-start gap-2.5 justify-end">
          <div class="flex items-start gap-2">
            <!-- Menú de opciones -->
            @if (puedeModificar(mensaje) && !otroUsuarioHaRespondido()) {
              <div class="relative group">
                <button
                  type="button"
                  title="Opciones del mensaje"
                  aria-label="Opciones del mensaje"
                  class="p-1.5 text-gray-500 hover:text-gray-700 rounded-lg hover:bg-gray-100"
                >
                  <i class="fas fa-ellipsis-v text-sm"></i>
                </button>
                <div
                  class="absolute right-0 hidden group-hover:block bg-white border border-gray-200 rounded-lg shadow-lg w-32 z-10"
                >
                  <button
                    (click)="iniciarEdicion(mensaje)"
                    class="block w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg"
                  >
                    <i class="fas fa-edit mr-2"></i>Editar
                  </button>
                  <button
                    (click)="eliminarMensaje(mensaje)"
                    class="block w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-b-lg"
                  >
                    <i class="fas fa-trash mr-2"></i>Eliminar
                  </button>
                </div>
              </div>
            }

            <!-- Modo edición -->
            @if (mensajeEditando()?.id === mensaje.id) {
              <div
                class="flex flex-col w-full max-w-[320px] p-3 bg-blue-50 border border-blue-300 rounded-s-lg rounded-ee-lg shadow-sm"
              >
                <textarea
                  [(ngModel)]="textoEditado"
                  placeholder="Edita tu mensaje..."
                  aria-label="Editar mensaje"
                  class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-fletway-orange focus:border-fletway-orange resize-none"
                  rows="3"
                ></textarea>
                <div class="flex gap-2 mt-2">
                  <button
                    (click)="guardarEdicion()"
                    class="flex-1 px-3 py-1.5 text-xs bg-fletway-orange text rounded-lg hover:bg-orange-600"
                  >
                    Guardar
                  </button>
                  <button
                    (click)="cancelarEdicion()"
                    class="flex-1 px-3 py-1.5 text-xs bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            } @else {
              <div
                class="flex flex-col w-full max-w-[320px] leading-1.5 p-3 bg-fletway-orange text rounded-s-lg rounded-ee-lg shadow-sm"
              >
                <div class="flex items-center space-x-2 mb-1">
                  <span class="text-xs text/80">
                    {{ formatearFecha(mensaje.created_at) }}
                  </span>
                </div>
                <p class="text-sm whitespace-pre-wrap">
                  {{ mensaje.mensaje }}
                </p>
                @if (mensaje.edited_at) {
                  <span class="text-xs text/70 italic mt-1">Editado</span>
                }
              </div>
            }
          </div>

          <div
            class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text font-bold"
          >
            <i class="fas fa-user text-sm"></i>
          </div>
        </div>
      }
    }
  </div>

  <!-- Input Area -->
  <div class="p-4 bg-white border-t border-gray-200">
    <div class="flex items-end gap-2">
      <textarea
        [(ngModel)]="nuevoMensaje"
        (keydown)="onEnterPress($event)"
        placeholder="Escribe tu mensaje... (Shift+Enter para nueva línea)"
        class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-fletway-orange focus:border-fletway-orange resize-none"
        rows="2"
      ></textarea>
      <button
        (click)="enviarMensaje()"
        [disabled]="!puedeEnviar()"
        class="px-4 py-3 bg-fletway-orange text rounded-lg hover:bg-orange-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
      >
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Presiona Enter para enviar, Shift+Enter para nueva línea
    </p>
  </div>
</div>
