# ğŸ’¬ GuÃ­a de Uso - Componente Chat

## DescripciÃ³n General

El componente `ChatComponent` es un sistema de mensajerÃ­a en tiempo real para negociaciÃ³n entre clientes y fleteros en Fletway. Utiliza **Supabase Realtime** para actualizaciones instantÃ¡neas, **Signals** de Angular 17+ para gestiÃ³n de estado reactivo, y **Flowbite UI** para el diseÃ±o.

---

## ğŸ¯ CaracterÃ­sticas

âœ… **MensajerÃ­a en tiempo real** con Supabase Realtime  
âœ… **EdiciÃ³n de mensajes** (solo si el otro usuario no ha respondido)  
âœ… **EliminaciÃ³n de mensajes** (soft delete)  
âœ… **Skeleton loader** durante carga inicial  
âœ… **Estado vacÃ­o** con mensaje motivacional  
âœ… **DiferenciaciÃ³n visual** entre mensajes propios (derecha) y ajenos (izquierda)  
âœ… **Scroll automÃ¡tico** al enviar mensajes  
âœ… **Formato de fecha** inteligente (hoy solo hora, pasado con fecha)  
âœ… **Soporte de Enter/Shift+Enter** para envÃ­o/nueva lÃ­nea

---

## ğŸ“‚ Estructura de Archivos

```
src/app/
â”œâ”€â”€ core/layouts/
â”‚   â””â”€â”€ mensaje.ts                    # Interfaces TypeScript
â”œâ”€â”€ shared/features/chat/
â”‚   â”œâ”€â”€ data-access/
â”‚   â”‚   â””â”€â”€ chat-service.ts           # Servicio con Signals y Realtime
â”‚   â””â”€â”€ chat/
â”‚       â”œâ”€â”€ chat.ts                   # Componente principal
â”‚       â”œâ”€â”€ chat.html                 # Template con Flowbite UI
â”‚       â””â”€â”€ chat.scss                 # Estilos personalizados
```

---

## ğŸ—„ï¸ Estructura de Base de Datos

### Tabla `mensajes`

```sql
CREATE TABLE public.mensajes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  solic_id INTEGER NOT NULL REFERENCES solicitud(solicitud_id) ON DELETE CASCADE,
  mensaje TEXT DEFAULT '',
  user_id UUID REFERENCES auth.users(id),

  -- Campos opcionales recomendados
  edited_at TIMESTAMP WITH TIME ZONE,
  deleted_at TIMESTAMP WITH TIME ZONE,
  is_read BOOLEAN DEFAULT FALSE
);

-- Ãndices para optimizaciÃ³n
CREATE INDEX idx_mensajes_solicitud ON mensajes(solic_id, created_at DESC);
CREATE INDEX idx_mensajes_user ON mensajes(user_id);
```

---

## ğŸš€ Uso del Componente

### 1. Como Popup (Recomendado)

#### En `ClienteComponent` o `FleteroComponent`:

**TypeScript:**

```typescript
import { ChatComponent } from "../../../shared/features/chat/chat/chat";

export class ClienteComponent {
  // Estado del popup
  popupChatAbierto = false;
  popupChatComponente: Type<any> | undefined;
  popupChatInputs: any = {};

  // MÃ©todo para abrir chat
  enviarMensaje(solicitud: Solicitud): void {
    this.popupChatComponente = ChatComponent;
    this.popupChatInputs = {
      solicitudId: solicitud.solicitud_id,
    };
    this.popupChatAbierto = true;
  }

  // MÃ©todo para cerrar
  cerrarPopupChat(): void {
    this.popupChatAbierto = false;
    this.popupChatComponente = undefined;
    this.popupChatInputs = {};
  }
}
```

**HTML:**

```html
<!-- Popup del Chat -->
<app-popup [(isOpen)]="popupChatAbierto" title="Chat de NegociaciÃ³n" size="lg" [customComponent]="popupChatComponente" [componentInputs]="popupChatInputs" (close)="cerrarPopupChat()"></app-popup>
```

### 2. Como Componente Directo

```html
<app-chat [solicitudId]="solicitudActual.solicitud_id"></app-chat>
```

---

## ğŸ”§ API del Servicio (`ChatService`)

### MÃ©todos PÃºblicos

#### `cargarMensajes(solicitudId: number, currentUserId: string): Promise<void>`

Carga los mensajes de una solicitud y suscribe a cambios en tiempo real.

```typescript
await this.chatService.cargarMensajes(123, "user-uuid");
```

#### `enviarMensaje(solicitudId: number, mensaje: string, userId: string): Promise<boolean>`

EnvÃ­a un nuevo mensaje.

```typescript
const exito = await this.chatService.enviarMensaje(123, "Hola!", "user-uuid");
```

#### `editarMensaje(mensajeId: number, nuevoTexto: string): Promise<boolean>`

Edita un mensaje existente.

```typescript
await this.chatService.editarMensaje(456, "Mensaje editado");
```

#### `eliminarMensaje(mensajeId: number): Promise<boolean>`

Elimina un mensaje (soft delete).

```typescript
await this.chatService.eliminarMensaje(456);
```

#### `limpiarChat(): void`

Limpia el estado y desuscribe del realtime.

```typescript
this.chatService.limpiarChat();
```

### Signals PÃºblicos

```typescript
// Obtener mensajes
const mensajes = this.chatService.mensajes();

// Obtener estado de carga
const loading = this.chatService.loading();

// Obtener errores
const error = this.chatService.error();
```

---

## ğŸ¨ UI y DiseÃ±o

### Paleta de Colores (Fletway)

- **Naranja Principal**: `#FF6F00` (bg-fletway-orange)
- **Azul GrisÃ¡ceo**: `#455A64`
- **Blanco**: `#FFFFFF`
- **Beige Claro**: `#FBE9E7`

### Estructura Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ§ Header (Orange)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â† Mensaje del otro   (izquierda)  â”‚
â”‚                                     â”‚
â”‚         Mensaje propio â†’ (derecha)  â”‚
â”‚         ğŸŸ¦ (naranja)                â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“ Input + ğŸ“¤ BotÃ³n Enviar          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Reglas de Negocio

### EdiciÃ³n y EliminaciÃ³n

1. **Solo el autor** puede editar/eliminar sus mensajes
2. **No se puede editar/eliminar** si el otro usuario ya respondiÃ³
3. **Soft delete**: Los mensajes eliminados no se borran fÃ­sicamente

### Validaciones

- Mensaje no puede estar vacÃ­o
- MÃ¡ximo de caracteres: ilimitado (whitespace-pre-wrap)
- Enter envÃ­a, Shift+Enter agrega nueva lÃ­nea

---

## ğŸ”” Realtime (Supabase)

El servicio se suscribe automÃ¡ticamente a cambios en la tabla `mensajes`:

```typescript
// Eventos escuchados:
- INSERT: Nuevo mensaje â†’ Se agrega al estado
- UPDATE: Mensaje editado â†’ Se actualiza en el estado
- DELETE: Mensaje eliminado â†’ Se remueve del estado
```

**Importante**: Llamar `limpiarChat()` en `ngOnDestroy` para evitar memory leaks.

---

## ğŸ› Debugging

### Logs en Consola

```
ğŸ’¬ Cargando mensajes para solicitud: 123
ğŸ“ ValidaciÃ³n origen: ... â†’ âœ“
ğŸ”” Suscrito a mensajes en tiempo real para solicitud: 123
âœ… Mensaje enviado correctamente
ğŸ”• Desuscrito de mensajes en tiempo real
```

### Errores Comunes

| Error                      | Causa                     | SoluciÃ³n                                          |
| -------------------------- | ------------------------- | ------------------------------------------------- |
| `Session is null`          | Usuario no autenticado    | Verificar `AuthService.session()`                 |
| `deleted_at is null fails` | Columna no existe         | Ejecutar migraciÃ³n para agregar campos opcionales |
| `Realtime not updating`    | No suscrito correctamente | Verificar que `cargarMensajes()` se llamÃ³         |

---

## ğŸ“Š Ejemplo Completo de IntegraciÃ³n

### FleteroComponent

```typescript
import { ChatComponent } from "../../../shared/features/chat/chat/chat";

export class FleteroComponent {
  popupChatAbierto = false;
  popupChatComponente: Type<any> | undefined;
  popupChatInputs: any = {};

  abrirChat(solicitud: Solicitud): void {
    console.log("ğŸ’¬ Abriendo chat:", solicitud.solicitud_id);

    this.popupChatComponente = ChatComponent;
    this.popupChatInputs = { solicitudId: solicitud.solicitud_id };
    this.popupChatAbierto = true;
  }
}
```

```html
<!-- En solicitud-card -->
<button (click)="enviarMensaje.emit(solicitud)">
  <i class="fas fa-comments"></i>
  Enviar Mensaje
</button>

<!-- En fletero-component.html -->
<app-popup [(isOpen)]="popupChatAbierto" title="Chat" size="lg" [customComponent]="popupChatComponente" [componentInputs]="popupChatInputs" (close)="popupChatAbierto = false"></app-popup>
```

---

## ğŸ” Seguridad

### Row Level Security (RLS)

**RecomendaciÃ³n**: Habilitar RLS en la tabla `mensajes`:

```sql
-- Solo los usuarios involucrados pueden ver mensajes
CREATE POLICY "Users can view their own messages"
ON mensajes FOR SELECT
USING (
  auth.uid() = user_id
  OR auth.uid() IN (
    SELECT u.u_id FROM solicitud s
    JOIN usuario u ON s.cliente_id = u.usuario_id
    WHERE s.solicitud_id = mensajes.solic_id
  )
  OR auth.uid() IN (
    SELECT u.u_id FROM solicitud s
    JOIN presupuesto p ON s.presupuesto_aceptado = p.presupuesto_id
    JOIN transportista t ON p.transportista_id = t.transportista_id
    JOIN usuario u ON t.usuario_id = u.usuario_id
    WHERE s.solicitud_id = mensajes.solic_id
  )
);
```

---

## âœ… Checklist de ImplementaciÃ³n

- [x] Crear tabla `mensajes` en Supabase
- [x] Definir interfaces TypeScript
- [x] Implementar `ChatService` con Signals
- [x] Crear componente `ChatComponent`
- [x] DiseÃ±ar UI con Flowbite
- [x] Integrar como popup en Cliente
- [ ] Integrar como popup en Fletero (opcional)
- [ ] Configurar RLS en Supabase
- [ ] Agregar tests unitarios
- [ ] Implementar notificaciones push (futuro)

---

## ğŸ“ Soporte

Para dudas o mejoras, consultar:

- DocumentaciÃ³n de Supabase Realtime
- GuÃ­a de Signals de Angular 17+
- DiseÃ±o de Flowbite Components

**Autor**: Sistema de Chat Fletway  
**VersiÃ³n**: 1.0.0  
**Ãšltima actualizaciÃ³n**: Enero 2026
